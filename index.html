<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Adaptive Sleep Noise Generator</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
      }

      .container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .controls {
        display: flex;
        flex-direction: column;
        gap: 25px;
        margin-bottom: 30px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      label {
        font-size: 1.2em;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .value-display {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9em;
        min-width: 80px;
        text-align: center;
      }

      input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.3);
        outline: none;
        -webkit-appearance: none;
        appearance: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      .play-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
      }

      button {
        padding: 15px 30px;
        font-size: 1.1em;
        border: none;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
      }

      button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      button:active {
        transform: translateY(0);
      }

      button.active {
        background: rgba(255, 255, 255, 0.4);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .noise-types {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .noise-type {
        padding: 10px 20px;
        font-size: 0.9em;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        background: transparent;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .noise-type.active {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.6);
      }

      .status {
        text-align: center;
        font-size: 1.1em;
        margin-top: 20px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        line-height: 1.6;
      }

      .algorithm-info {
        font-size: 0.9em;
        color: rgba(255, 255, 255, 0.8);
        margin-top: 10px;
      }

      .sound-layers {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .layer-indicator {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        font-size: 0.9em;
      }

      .layer-status {
        background: rgba(0, 255, 0, 0.3);
        padding: 3px 8px;
        border-radius: 8px;
        font-size: 0.8em;
      }

      .waveform-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
      }

      .waveform-title {
        text-align: center;
        margin-bottom: 15px;
        font-size: 1.1em;
        font-weight: bold;
      }

      #waveformCanvas {
        width: 100%;
        height: 150px;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.2);
        display: block;
      }

      .wave-legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 10px;
        font-size: 0.9em;
      }

      .wave-legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .wave-color-box {
        width: 20px;
        height: 3px;
        border-radius: 2px;
      }

      .ocean-wave-color {
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      }

      .heart-wave-color {
        background: linear-gradient(90deg, #ff6b6b 0%, #ff8e8e 100%);
      }

      @media (max-width: 600px) {
        .container {
          padding: 20px;
        }

        h1 {
          font-size: 2em;
        }

        .play-controls {
          flex-direction: column;
          align-items: center;
        }

        button {
          width: 100%;
          max-width: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üåô Enhanced Adaptive Sleep Noise</h1>

      <div class="controls">
        <div class="control-group">
          <label>
            Resting Heart Rate (BPM)
            <span class="value-display" id="heartRateValue">70</span>
          </label>
          <input type="range" id="heartRate" min="40" max="120" value="70" />
        </div>

        <div class="control-group">
          <label>
            Resting Breath Rate (BPM)
            <span class="value-display" id="breathRateValue">15</span>
          </label>
          <input type="range" id="breathRate" min="8" max="25" value="15" />
        </div>

        <div class="control-group">
          <label>
            Ambient Volume
            <span class="value-display" id="ambientVolumeValue">Medium</span>
          </label>
          <input type="range" id="ambientVolume" min="0" max="100" value="50" />
        </div>
      </div>

      <div class="sound-layers">
        <h3 style="margin-bottom: 15px">üéµ Active Sound Layers</h3>
        <div class="layer-indicator">
          <span>üíì Rhythmic Noise Pulse</span>
          <span class="layer-status" id="heartStatus">Ready</span>
        </div>
        <div class="layer-indicator">
          <span>üåä Ocean Wave Breathing</span>
          <span class="layer-status" id="breathStatus">Ready</span>
        </div>
      </div>

      <div class="waveform-container">
        <div class="waveform-title">üåä Real-Time Waveform Visualization</div>
        <canvas id="waveformCanvas" width="800" height="150"></canvas>
        <div class="wave-legend">
          <div class="wave-legend-item">
            <div class="wave-color-box ocean-wave-color"></div>
            <span>Ocean Wave Breathing</span>
          </div>
          <div class="wave-legend-item">
            <div class="wave-color-box heart-wave-color"></div>
            <span>Noise Pulse</span>
          </div>
        </div>
      </div>

      <div class="noise-types">
        <button class="noise-type active" data-type="white">White Noise</button>
        <button class="noise-type" data-type="pink">Pink Noise</button>
        <button class="noise-type" data-type="brown">Brown Noise</button>
      </div>

      <div class="play-controls">
        <button id="playBtn">‚ñ∂Ô∏è Start Sleep Mode</button>
        <button id="stopBtn" style="display: none">‚èπÔ∏è Stop</button>
      </div>

      <div class="status" id="status">
        <div>Algorithm Status: Ready</div>
        <div class="algorithm-info" id="algorithmInfo">
          Set your resting rates and press Start to begin the 15-minute sleep
          sequence.
        </div>
      </div>
    </div>

    <script>
      class EnhancedAdaptiveSleepNoise {
        constructor() {
          // Core properties
          this.audioContext = null;
          this.isPlaying = false;
          this.currentNoiseType = "white";

          // Audio nodes
          this.masterGain = null;
          this.noiseGain = null;
          this.breathGain = null;
          this.noiseNode = null;
          this.noiseFilter = null;
          this.breathOscillator1 = null;
          this.breathOscillator2 = null;
          this.breathLFO = null;
          this.breathFilter = null;

          // Rhythmic pulse nodes
          this.heartPulseLFO = null;
          this.heartPulseDepth = null;

          // Tempo slowdown properties
          this.slowdownDuration = 15 * 60 * 1000; // 15 minutes in ms
          this.slowdownIntervalId = null;
          this.startTime = 0;

          // Dynamic rate properties
          this.restingHeartRate = 70;
          this.currentHeartRate = 70;
          this.restingBreathRate = 15;
          this.currentBreathRate = 15;

          // Waveform visualization
          this.canvas = null;
          this.ctx = null;
          this.animationId = null;
          this.wavePhase = 0;
          this.heartPhase = 0;

          this.initializeControls();
          this.setupCanvas();
        }

        setupCanvas() {
          this.canvas = document.getElementById("waveformCanvas");
          this.ctx = this.canvas.getContext("2d");
          const rect = this.canvas.getBoundingClientRect();
          const dpr = window.devicePixelRatio || 1;
          this.canvas.width = rect.width * dpr;
          this.canvas.height = rect.height * dpr;
          this.ctx.scale(dpr, dpr);
          this.animateWaveform();
        }

        animateWaveform() {
          if (!this.canvas || !this.ctx) return;

          const width = this.canvas.width / (window.devicePixelRatio || 1);
          const height = this.canvas.height / (window.devicePixelRatio || 1);
          this.ctx.clearRect(0, 0, width, height);

          const oceanWaveAmplitude = height * 0.2;
          const heartWaveAmplitude = height * 0.15;
          const centerY = height / 2;

          const breathFreq = this.currentBreathRate / 60; // Hz
          const heartFreq = this.currentHeartRate / 60; // Hz
          this.wavePhase += breathFreq * 0.1;
          this.heartPhase += heartFreq * 0.1;

          // Draw ocean wave
          this.ctx.beginPath();
          this.ctx.strokeStyle = this.isPlaying
            ? "#4facfe"
            : "rgba(79, 172, 254, 0.3)";
          this.ctx.lineWidth = 3;
          for (let x = 0; x < width; x++) {
            const angle = (x / width) * Math.PI + this.wavePhase;
            const y = centerY + Math.sin(angle) * oceanWaveAmplitude;
            x === 0 ? this.ctx.moveTo(x, y) : this.ctx.lineTo(x, y);
          }
          this.ctx.stroke();

          // Draw heart rhythm pulse wave
          this.ctx.beginPath();
          this.ctx.strokeStyle = this.isPlaying
            ? "#ff6b6b"
            : "rgba(255, 107, 107, 0.3)";
          this.ctx.lineWidth = 2;
          for (let x = 0; x < width; x++) {
            const heartCycles = (this.currentHeartRate / 60) * 2;
            const heartAngle =
              (x / width) * Math.PI * heartCycles + this.heartPhase;
            const heartY = Math.sin(heartAngle) * heartWaveAmplitude;
            const finalY = centerY + heartY;
            x === 0 ? this.ctx.moveTo(x, finalY) : this.ctx.lineTo(x, finalY);
          }
          this.ctx.stroke();

          // Draw center line and text
          this.ctx.beginPath();
          this.ctx.strokeStyle = "rgba(255, 255, 255, 0.2)";
          this.ctx.lineWidth = 1;
          this.ctx.setLineDash([5, 5]);
          this.ctx.moveTo(0, centerY);
          this.ctx.lineTo(width, centerY);
          this.ctx.stroke();
          this.ctx.setLineDash([]);
          this.ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
          this.ctx.font = "12px Arial";
          this.ctx.textAlign = "left";
          this.ctx.fillText(
            `üåä Ocean: ${Math.round(this.currentBreathRate)} BPM`,
            10,
            20
          );
          this.ctx.fillText(
            `üíì Pulse: ${Math.round(this.currentHeartRate)} BPM`,
            10,
            40
          );

          this.animationId = requestAnimationFrame(() =>
            this.animateWaveform()
          );
        }

        initializeControls() {
          document
            .getElementById("heartRate")
            .addEventListener("input", (e) => {
              document.getElementById("heartRateValue").textContent =
                e.target.value;
              if (!this.isPlaying) this.updateAlgorithmInfo();
            });
          document
            .getElementById("breathRate")
            .addEventListener("input", (e) => {
              document.getElementById("breathRateValue").textContent =
                e.target.value;
              if (!this.isPlaying) this.updateAlgorithmInfo();
            });
          document
            .getElementById("ambientVolume")
            .addEventListener("input", (e) => {
              const value = parseInt(e.target.value);
              let label = "Low";
              if (value > 66) label = "High";
              else if (value > 33) label = "Medium";
              document.getElementById("ambientVolumeValue").textContent = label;
              if (this.isPlaying) this.updateVolume();
            });
          document.querySelectorAll(".noise-type").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              document
                .querySelectorAll(".noise-type")
                .forEach((b) => b.classList.remove("active"));
              e.target.classList.add("active");
              this.currentNoiseType = e.target.dataset.type;
            });
          });
          document
            .getElementById("playBtn")
            .addEventListener("click", () => this.startSleepMode());
          document
            .getElementById("stopBtn")
            .addEventListener("click", () => this.stopSleepMode());
        }

        async startSleepMode() {
          try {
            this.audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
            await this.audioContext.resume();

            // Set initial and target rates
            this.restingHeartRate = parseInt(
              document.getElementById("heartRate").value
            );
            this.restingBreathRate = parseInt(
              document.getElementById("breathRate").value
            );
            this.currentHeartRate = this.restingHeartRate * 1.25;
            this.currentBreathRate = this.restingBreathRate * 1.25;
            this.startTime = this.audioContext.currentTime;

            this.createAudioNodes();
            this.updateVolume();

            this.isPlaying = true;
            document.getElementById("playBtn").style.display = "none";
            document.getElementById("stopBtn").style.display = "block";
            document
              .querySelectorAll('input[type="range"]')
              .forEach((input) => (input.disabled = true));

            // Start processes
            this.startSlowdown();

            // Update UI
            document.getElementById("heartStatus").textContent = "Active";
            document.getElementById("breathStatus").textContent = "Active";
            this.updateAlgorithmInfo();
          } catch (error) {
            console.error("Error starting audio:", error);
            document.getElementById(
              "status"
            ).innerHTML = `<div>Error: Could not start audio.</div>`;
          }
        }

        stopSleepMode() {
          if (this.slowdownIntervalId) clearInterval(this.slowdownIntervalId);
          this.slowdownIntervalId = null;

          if (this.audioContext) {
            this.audioContext.close().then(() => {
              this.audioContext = null;
            });
          }

          this.isPlaying = false;
          document.getElementById("playBtn").style.display = "block";
          document.getElementById("stopBtn").style.display = "none";
          document
            .querySelectorAll('input[type="range"]')
            .forEach((input) => (input.disabled = false));

          // Reset current rates to resting for the visualization
          this.currentHeartRate = parseInt(
            document.getElementById("heartRate").value
          );
          this.currentBreathRate = parseInt(
            document.getElementById("breathRate").value
          );

          document.getElementById("heartStatus").textContent = "Ready";
          document.getElementById("breathStatus").textContent = "Ready";
          document.getElementById("status").innerHTML = `
                    <div>Algorithm Status: Stopped</div>
                    <div class="algorithm-info" id="algorithmInfo">Sweet dreams! üåô</div>
                `;
        }

        createAudioNodes() {
          this.masterGain = this.audioContext.createGain();
          this.masterGain.connect(this.audioContext.destination);

          this.noiseGain = this.audioContext.createGain();
          this.breathGain = this.audioContext.createGain();
          this.noiseGain.connect(this.masterGain);
          this.breathGain.connect(this.masterGain);

          this.createNoiseLayer();
          this.createNoisePulseLayer();
          this.createOceanWaveLayer();
        }

        createNoiseLayer() {
          const bufferSize = 4096;
          this.noiseNode = this.audioContext.createScriptProcessor(
            bufferSize,
            1,
            1
          );
          this.noiseNode.onaudioprocess = (e) => {
            const output = e.outputBuffer.getChannelData(0);
            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
              switch (this.currentNoiseType) {
                case "white":
                  output[i] = Math.random() * 2 - 1;
                  break;
                case "pink":
                  const b0 =
                    0.99886 * lastOut + (Math.random() * 2 - 1) * 0.0555179;
                  const b1 =
                    0.99332 * lastOut + (Math.random() * 2 - 1) * 0.0750759;
                  const b2 =
                    0.969 * lastOut + (Math.random() * 2 - 1) * 0.153852;
                  output[i] = b0 + b1 + b2 + (Math.random() * 2 - 1) * 0.01;
                  lastOut = output[i];
                  break;
                case "brown":
                  const white = Math.random() * 2 - 1;
                  output[i] = (lastOut + 0.02 * white) / 1.02;
                  lastOut = output[i];
                  break;
              }
            }
          };
          this.noiseFilter = this.audioContext.createBiquadFilter();
          this.noiseFilter.type = "lowpass";
          this.noiseFilter.frequency.setValueAtTime(
            2000,
            this.audioContext.currentTime
          );
          this.noiseNode.connect(this.noiseFilter).connect(this.noiseGain);
        }

        createNoisePulseLayer() {
          this.heartPulseLFO = this.audioContext.createOscillator();
          this.heartPulseLFO.type = "sine";
          this.heartPulseLFO.frequency.setValueAtTime(
            this.currentHeartRate / 60,
            this.audioContext.currentTime
          );

          this.heartPulseDepth = this.audioContext.createGain();
          // This controls the depth of the pulse. A small value makes it subtle.
          this.heartPulseDepth.gain.setValueAtTime(
            0.08,
            this.audioContext.currentTime
          );

          this.heartPulseLFO.connect(this.heartPulseDepth);
          // The LFO's output is ADDED to the gain's base value.
          this.heartPulseDepth.connect(this.noiseGain.gain);

          this.heartPulseLFO.start();
        }

        createOceanWaveLayer() {
          this.breathOscillator1 = this.audioContext.createOscillator();
          this.breathOscillator2 = this.audioContext.createOscillator();
          this.breathLFO = this.audioContext.createOscillator();

          this.breathOscillator1.type = "sine";
          this.breathOscillator2.type = "sine";
          this.breathLFO.type = "sine";

          this.breathOscillator1.frequency.setValueAtTime(
            80,
            this.audioContext.currentTime
          );
          this.breathOscillator2.frequency.setValueAtTime(
            120,
            this.audioContext.currentTime
          );
          this.breathLFO.frequency.setValueAtTime(
            this.currentBreathRate / 60,
            this.audioContext.currentTime
          );

          const wave1Gain = this.audioContext.createGain();
          const wave2Gain = this.audioContext.createGain();
          const lfoGain = this.audioContext.createGain();
          wave1Gain.gain.value = 0.4;
          wave2Gain.gain.value = 0.6;
          lfoGain.gain.value = 1.0;

          this.breathFilter = this.audioContext.createBiquadFilter();
          this.breathFilter.type = "bandpass";
          this.breathFilter.frequency.setValueAtTime(
            400,
            this.audioContext.currentTime
          );
          this.breathFilter.Q.setValueAtTime(
            0.8,
            this.audioContext.currentTime
          );

          this.breathOscillator1.connect(wave1Gain);
          this.breathOscillator2.connect(wave2Gain);
          this.breathLFO.connect(lfoGain).connect(this.breathGain.gain);
          wave1Gain.connect(this.breathFilter);
          wave2Gain.connect(this.breathFilter);
          this.breathFilter.connect(this.breathGain);

          this.breathOscillator1.start();
          this.breathOscillator2.start();
          this.breathLFO.start();
        }

        startSlowdown() {
          this.slowdownIntervalId = setInterval(() => {
            if (!this.audioContext) return;
            const elapsedTime =
              (this.audioContext.currentTime - this.startTime) * 1000;
            if (elapsedTime >= this.slowdownDuration) {
              this.currentHeartRate = this.restingHeartRate;
              this.currentBreathRate = this.restingBreathRate;
              clearInterval(this.slowdownIntervalId);
              this.slowdownIntervalId = null;
            } else {
              const progress = elapsedTime / this.slowdownDuration;
              const startHeartRate = this.restingHeartRate * 1.25;
              const startBreathRate = this.restingBreathRate * 1.25;
              this.currentHeartRate =
                startHeartRate -
                (startHeartRate - this.restingHeartRate) * progress;
              this.currentBreathRate =
                startBreathRate -
                (startBreathRate - this.restingBreathRate) * progress;
            }

            // Update audio param frequencies smoothly
            const transitionTime = 1; // 1 second for smooth transition
            if (this.heartPulseLFO) {
              this.heartPulseLFO.frequency.setTargetAtTime(
                this.currentHeartRate / 60,
                this.audioContext.currentTime,
                transitionTime
              );
            }
            if (this.breathLFO) {
              this.breathLFO.frequency.setTargetAtTime(
                this.currentBreathRate / 60,
                this.audioContext.currentTime,
                transitionTime
              );
            }
            this.updateAlgorithmInfo();
          }, 1000); // Update every second
        }

        updateVolume() {
          if (!this.isPlaying) return;
          const ambientVolume =
            parseInt(document.getElementById("ambientVolume").value) / 100;

          const noiseBaseVol = 0.25 + ambientVolume * 0.25; // Base volume from 0.25 to 0.5
          const breathVol = 0.3 + ambientVolume * 0.3; // Breath volume from 0.3 to 0.6

          this.noiseGain.gain.setTargetAtTime(
            noiseBaseVol,
            this.audioContext.currentTime,
            0.5
          );
          this.breathGain.gain.setTargetAtTime(
            breathVol,
            this.audioContext.currentTime,
            0.5
          );
        }

        updateAlgorithmInfo() {
          const info = this.getAlgorithmDescription();
          const algorithmInfoElement = document.getElementById("algorithmInfo");
          if (algorithmInfoElement) {
            algorithmInfoElement.innerHTML = info;
          }
        }

        getAlgorithmDescription() {
          if (!this.isPlaying) {
            return `Set your resting rates and press Start to begin the 15-minute sleep sequence.`;
          }
          const startHeartRate = Math.round(this.restingHeartRate * 1.25);
          let description = `<strong>Sleep Sequence Active:</strong><br>`;
          description += `Gradually slowing pulse from <strong>${startHeartRate} BPM</strong> down to <strong>${this.restingHeartRate} BPM</strong> over 15 minutes.<br>`;
          description += `Current Target: <strong>${Math.round(
            this.currentHeartRate
          )} BPM</strong>`;
          return description;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        new EnhancedAdaptiveSleepNoise();
      });
    </script>
  </body>
</html>
